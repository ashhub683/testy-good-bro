name: Test-Xray-Config

on:
  push:
  pull_request:

jobs:
  test-xray:
    runs-on: ubuntu-latest
    steps:
      # مراحل نصب و تنظیم Xray مانند قبل...

      - name: Test Proxy with YouTube
        id: youtube_test
        run: |
          if ! curl --socks5 127.0.0.1:1080 -o /dev/null -s -w "%{http_code}" -v https://www.youtube.com > youtube_response.txt; then
            echo "::error::Failed to connect to YouTube"
            exit 1
          fi
          RESPONSE_CODE=$(cat youtube_response.txt)
          if [ "$RESPONSE_CODE" -ne 200 ]; then
            echo "::error::YouTube returned HTTP $RESPONSE_CODE"
            exit 1
          fi

      - name: Check IP & Country via API
        id: ip_check
        run: |
          if ! curl --socks5 127.0.0.1:1080 -s https://ipinfo.io/json > ip_info.json; then
            echo "::error::Failed to get IP information"
            exit 1
          fi
          jq -e '.ip' ip_info.json || (echo "::error::Invalid IP response"; exit 1)

      - name: Validate Configuration
        if: always()
        run: |
          FAILURE_COUNT=0
          [ "${{ steps.youtube_test.outcome }}" != "success" ] && FAILURE_COUNT=$((FAILURE_COUNT+1))
          [ "${{ steps.ip_check.outcome }}" != "success" ] && FAILURE_COUNT=$((FAILURE_COUNT+1))
          
          if [ $FAILURE_COUNT -gt 0 ]; then
            echo "::error::🛑 این کانفیگ خراب است! (مشکل در $FAILURE_COUNT تست)"
            echo "----------------------------------------"
            echo "راه‌حل‌های احتمالی:"
            echo "1. تنظیمات TLS و WS را بررسی کنید"
            echo "2. اتصال به سرور خارج را تست کنید"
            echo "3. شناسه کاربری (UUID) را چک کنید"
            echo "4. پورت و آدرس سرور را بررسی نمایید"
            exit 1
          else
            echo "✅ کانفیگ به درستی کار می‌کند!"
          fi
