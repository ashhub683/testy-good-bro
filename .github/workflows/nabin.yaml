name: Test-Xray-Config

on:
  push:
  pull_request:

jobs:
  test-xray:
    runs-on: ubuntu-latest
    steps:
      # ูุฑุงุญู ูุตุจ ู ุชูุธู Xray ูุงููุฏ ูุจู...

      - name: Test Proxy with YouTube
        id: youtube_test
        run: |
          if ! curl --socks5 127.0.0.1:1080 -o /dev/null -s -w "%{http_code}" -v https://www.youtube.com > youtube_response.txt; then
            echo "::error::Failed to connect to YouTube"
            exit 1
          fi
          RESPONSE_CODE=$(cat youtube_response.txt)
          if [ "$RESPONSE_CODE" -ne 200 ]; then
            echo "::error::YouTube returned HTTP $RESPONSE_CODE"
            exit 1
          fi

      - name: Check IP & Country via API
        id: ip_check
        run: |
          if ! curl --socks5 127.0.0.1:1080 -s https://ipinfo.io/json > ip_info.json; then
            echo "::error::Failed to get IP information"
            exit 1
          fi
          jq -e '.ip' ip_info.json || (echo "::error::Invalid IP response"; exit 1)

      - name: Validate Configuration
        if: always()
        run: |
          FAILURE_COUNT=0
          [ "${{ steps.youtube_test.outcome }}" != "success" ] && FAILURE_COUNT=$((FAILURE_COUNT+1))
          [ "${{ steps.ip_check.outcome }}" != "success" ] && FAILURE_COUNT=$((FAILURE_COUNT+1))
          
          if [ $FAILURE_COUNT -gt 0 ]; then
            echo "::error::๐ ุงู ฺฉุงููฺฏ ุฎุฑุงุจ ุงุณุช! (ูุดฺฉู ุฏุฑ $FAILURE_COUNT ุชุณุช)"
            echo "----------------------------------------"
            echo "ุฑุงูโุญูโูุง ุงุญุชูุงู:"
            echo "1. ุชูุธูุงุช TLS ู WS ุฑุง ุจุฑุฑุณ ฺฉูุฏ"
            echo "2. ุงุชุตุงู ุจู ุณุฑูุฑ ุฎุงุฑุฌ ุฑุง ุชุณุช ฺฉูุฏ"
            echo "3. ุดูุงุณู ฺฉุงุฑุจุฑ (UUID) ุฑุง ฺฺฉ ฺฉูุฏ"
            echo "4. ูพูุฑุช ู ุขุฏุฑุณ ุณุฑูุฑ ุฑุง ุจุฑุฑุณ ููุงุฏ"
            exit 1
          else
            echo "โ ฺฉุงููฺฏ ุจู ุฏุฑุณุช ฺฉุงุฑ ูโฺฉูุฏ!"
          fi
